<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 èµ›åšç¥ç¥—Â·ä¸‡è±¡æ›´æ–°</title>
    <link href="https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&family=Orbitron:wght@500&display=swap" rel="stylesheet">
    
    <!-- MediaPipe åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Orbitron', sans-serif; user-select: none; }
        
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* UI å±‚ */
        #ui-layer {
            position: absolute; width: 100%; height: 100%; z-index: 10;
            pointer-events: none; display: flex; justify-content: center; align-items: center;
        }

        /* å¯åŠ¨ç”»é¢ */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #0ff; backdrop-filter: blur(10px);
        }
        
        .cyber-btn {
            background: transparent; color: #0ff; font-family: 'Orbitron', sans-serif;
            font-size: 2rem; padding: 15px 40px; border: 2px solid #0ff;
            box-shadow: 0 0 20px #0ff; cursor: pointer; transition: 0.3s;
            text-shadow: 0 0 10px #0ff; margin-top: 20px;
        }
        .cyber-btn:hover { background: #0ff; color: #000; box-shadow: 0 0 50px #0ff; }

        /* æ‘„åƒå¤´é¢„è§ˆ - èµ›åšé£æ ¼ */
        .cam-frame {
            position: absolute; bottom: 20px; right: 20px; width: 200px; height: 150px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            background: rgba(0, 20, 20, 0.8);
            transform: scaleX(-1); /* é•œåƒ */
            z-index: 5;
            overflow: hidden;
        }
        .cam-frame::before {
            content: "SYSTEM ONLINE"; position: absolute; top: 5px; right: 5px;
            font-size: 10px; color: #0ff; transform: scaleX(-1);
        }
        video { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }

        /*  HUD çŠ¶æ€æ  */
        .hud {
            position: absolute; top: 20px; left: 20px; color: rgba(0, 255, 255, 0.8);
            font-size: 14px; text-shadow: 0 0 5px #0ff;
            border-left: 3px solid #0ff; padding-left: 10px;
        }

        /* æŠ½ç­¾å¡ç‰‡ 3D */
        .card-container {
            perspective: 1000px; display: none;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
        }
        .card {
            width: 300px; background: rgba(10, 10, 20, 0.9);
            border: 2px solid #FF0055; box-shadow: 0 0 50px rgba(255, 0, 85, 0.4);
            border-radius: 15px; padding: 30px; text-align: center; color: #fff;
            transform-style: preserve-3d;
        }
        .card h2 {
            font-family: 'Zcool KuaiLe', cursive; font-size: 4rem; margin: 0;
            background: linear-gradient(to bottom, #FF0055, #FFD700);
            -webkit-background-clip: text; color: transparent;
            filter: drop-shadow(0 0 10px rgba(255,0,85,0.8));
        }

        @keyframes popIn { 0% { transform: scale(0) rotateX(45deg); } 100% { transform: scale(1) rotateX(0); } }
        
        /* ç©æ³•è¯´æ˜ */
        .guide {
            position: absolute; top: 20px; right: 20px; text-align: right; color: rgba(255,255,255,0.6); font-size: 12px;
        }
        .guide b { color: #FFD700; margin-left: 5px; }
    </style>
</head>
<body>

    <!-- å¯åŠ¨å±‚ -->
    <div id="start-screen">
        <h1 style="font-size:3rem; margin-bottom:10px; text-shadow: 0 0 20px #0ff;">CYBER NEW YEAR 2026</h1>
        <p>éœ€è¦æ‘„åƒå¤´æƒé™ Â· è¯·è°ƒå¤§éŸ³é‡</p>
        <button class="cyber-btn" onclick="initSystem()">INITIALIZE >></button>
    </div>

    <!-- èƒŒæ™¯æ˜Ÿç©º -->
    <canvas id="star-canvas"></canvas>
    <!-- ä¸»äº¤äº’å±‚ -->
    <canvas id="main-canvas"></canvas>

    <!-- UI -->
    <div id="ui-layer">
        <div class="hud">
            <div>CPU: <span id="fps">60</span> FPS</div>
            <div>HAND: <span id="hand-status">SEARCHING...</span></div>
            <div>MODE: <span id="gesture-mode" style="color:#FFD700">-</span></div>
        </div>

        <div class="guide">
            <div>â˜ï¸ å•æŒ‡ç§»åŠ¨ <b>ç²’å­å…‰ç¬”</b></div>
            <div>âœŠ æ¡ç´§æ‹³å¤´ <b>å¼•åŠ›é»‘æ´</b></div>
            <div>âœŒï¸ å‰ªåˆ€æ‰‹åŠ¿ <b>æ–°å¹´çµç­¾</b></div>
            <div>âœ‹ å¼ å¼€æ‰‹æŒ <b>ç³»ç»Ÿé‡ç½®</b></div>
        </div>

        <div class="card-container" id="card-box">
            <div class="card">
                <div style="font-size:12px; color:#aaa; margin-bottom:10px;">NEO-SHANGHAI Â· 2026</div>
                <h2 id="card-word">å¤§å‰</h2>
                <p id="card-text" style="font-size:16px; line-height:1.6; color:#ddd; margin-top:20px;">
                    ä¸‡ç‰©äº’è”ï¼Œå¿ƒæƒ³äº‹æˆã€‚
                </p>
                <div style="margin-top:20px; height:2px; background:linear-gradient(90deg, transparent, #FF0055, transparent);"></div>
            </div>
        </div>
    </div>

    <!-- æ‘„åƒå¤´ -->
    <div class="cam-frame">
        <video id="input_video" playsinline></video>
    </div>

    <script>
        /* =========================================
           PART 0: éŸ³æ•ˆåˆæˆå¼•æ“ (Web Audio API)
           æ— éœ€åŠ è½½å¤–éƒ¨æ–‡ä»¶ï¼Œçº¯ä»£ç ç”ŸæˆéŸ³æ•ˆ
           ========================================= */
        const AudioEngine = {
            ctx: null,
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },
            playTone: function(freq, type, duration, vol=0.1) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playSparkle: function() { // ç²’å­é—ªçƒå£°
                // éšæœºé«˜é¢‘æ­£å¼¦æ³¢
                this.playTone(800 + Math.random()*1200, 'sine', 0.1, 0.05);
            },
            playBoom: function() { // çˆ†ç‚¸å£°
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.5);
            },
            playCharge: function() { // èšèƒ½å£° (ä½é¢‘å—¡å—¡)
                this.playTone(150 + Math.random()*50, 'triangle', 0.1, 0.05);
            },
            playSuccess: function() { // æˆåŠŸ/å¼€å¥–
                this.playTone(440, 'sine', 0.1, 0.1);
                setTimeout(() => this.playTone(554, 'sine', 0.2, 0.1), 100);
                setTimeout(() => this.playTone(659, 'sine', 0.4, 0.1), 200);
            }
        };

        /* =========================================
           PART 1: è§†è§‰ç³»ç»Ÿ (Canvas & Particles)
           ========================================= */
        const canvas = document.getElementById('main-canvas');
        const starCanvas = document.getElementById('star-canvas');
        const ctx = canvas.getContext('2d');
        const starCtx = starCanvas.getContext('2d');
        let width, height;

        // è°ƒæ•´ç”»å¸ƒå°ºå¯¸
        function resize() {
            width = canvas.width = starCanvas.width = window.innerWidth;
            height = canvas.height = starCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // ğŸŒŒ æ˜Ÿç©ºèƒŒæ™¯
        const stars = Array.from({length: 200}, () => ({
            x: Math.random() * width,
            y: Math.random() * height,
            size: Math.random() * 2,
            blink: Math.random() * 0.05
        }));

        function drawStars() {
            starCtx.fillStyle = '#050505';
            starCtx.fillRect(0, 0, width, height);
            starCtx.fillStyle = '#fff';
            stars.forEach(s => {
                starCtx.globalAlpha = 0.5 + Math.sin(Date.now() * 0.005 + s.x) * 0.5;
                starCtx.beginPath();
                starCtx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                starCtx.fill();
            });
            requestAnimationFrame(drawStars);
        }

        // âœ¨ ç‰©ç†ç²’å­ç³»ç»Ÿ
        let particles = [];
        class Particle {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type; // 'magic', 'fire', 'grav'
                this.life = 100;
                
                if(type === 'magic') {
                    this.vx = (Math.random() - 0.5) * 2;
                    this.vy = (Math.random() - 0.5) * 2;
                    this.size = Math.random() * 3 + 1;
                    this.color = `hsl(${Math.random()*50 + 160}, 100%, 70%)`; // é’è‰²/ç§‘æŠ€è“
                    this.drag = 0.95;
                } else if (type === 'fire') {
                    const a = Math.random() * Math.PI * 2;
                    const s = Math.random() * 10;
                    this.vx = Math.cos(a) * s;
                    this.vy = Math.sin(a) * s;
                    this.size = Math.random() * 5 + 2;
                    this.color = `hsl(${Math.random()*60 + 330}, 100%, 60%)`; // èµ›åšç²‰/çº¢
                    this.drag = 0.92;
                    this.gravity = 0.2;
                } else if (type === 'grav') {
                    // è¢«å¸å…¥çš„ç²’å­
                    this.vx = (Math.random() - 0.5) * 10;
                    this.vy = (Math.random() - 0.5) * 10;
                    this.size = Math.random() * 2;
                    this.color = '#FFD700';
                    this.drag = 0.9;
                }
            }
            update(targetX, targetY, attract = false) {
                if (attract) {
                    // å¼•åŠ›æ¨¡å¼ï¼šé£å‘ç›®æ ‡ç‚¹ (é»‘æ´)
                    const dx = targetX - this.x;
                    const dy = targetY - this.y;
                    this.vx += dx * 0.02;
                    this.vy += dy * 0.02;
                    this.life = 100; // åªè¦è¢«å¸ä½å°±ä¸æ¶ˆå¤±
                } else {
                    // æ™®é€šç‰©ç†æ¨¡å¼
                    this.vx *= this.drag;
                    this.vy *= this.drag;
                    if(this.gravity) this.vy += this.gravity;
                    this.life -= 1.5;
                }
                
                this.x += this.vx;
                this.y += this.vy;
                this.size *= 0.97;
            }
            draw() {
                ctx.globalCompositeOperation = 'lighter';
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
                ctx.fill();
                ctx.globalCompositeOperation = 'source-over';
            }
        }

        /* =========================================
           PART 2: é€»è¾‘æ§åˆ¶ & æ‰‹åŠ¿è¯†åˆ«
           ========================================= */
        const videoElement = document.getElementById('input_video');
        const cardBox = document.getElementById('card-box');
        
        let handPos = { x: 0, y: 0 }; // æŒå¿ƒä½ç½®
        let indexPos = { x: 0, y: 0 }; // é£ŸæŒ‡æŒ‡å°–
        let isFist = false;
        let showResult = false;
        let cooldown = false;

        // æ ¸å¿ƒå¾ªç¯
        function loop() {
            // 1. æ‹–å°¾æ¸…é™¤ (äº§ç”ŸåŠ¨æ€æ¨¡ç³Š)
            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
            ctx.fillRect(0, 0, width, height);

            // 2. æ¡æ‹³æ—¶çš„å¼•åŠ›åœºç‰¹æ•ˆ (Gravity Well)
            if(isFist) {
                // éšæœºç”Ÿæˆå‘¨å›´çš„ç²’å­å¹¶è¢«å¸å…¥
                for(let i=0; i<3; i++) {
                    let angle = Math.random() * Math.PI * 2;
                    let dist = 100 + Math.random() * 100;
                    let px = handPos.x + Math.cos(angle) * dist;
                    let py = handPos.y + Math.sin(angle) * dist;
                    particles.push(new Particle(px, py, 'grav'));
                }
                if(Math.random() > 0.8) AudioEngine.playCharge(); // å—¡å—¡å£°
            }

            // 3. æ›´æ–°ç²’å­
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.update(handPos.x, handPos.y, isFist && p.type === 'grav');
                p.draw();
                
                // ç§»é™¤è¿‡å°æˆ–æ¶ˆå¤±çš„ç²’å­
                if (p.life <= 0 || p.size < 0.1) {
                    particles.splice(i, 1);
                } 
                // å¦‚æœæ˜¯è¢«å¸å…¥çš„ç²’å­ç¢°åˆ°æ‰‹å¿ƒ -> æ¶ˆå¤±
                else if (isFist && Math.abs(p.x - handPos.x) < 20 && Math.abs(p.y - handPos.y) < 20) {
                    particles.splice(i, 1);
                }
            }

            requestAnimationFrame(loop);
        }

        // å¯åŠ¨ç³»ç»Ÿ
        function initSystem() {
            document.getElementById('start-screen').style.display = 'none';
            AudioEngine.init(); // æ¿€æ´»éŸ³é¢‘
            drawStars(); // å¯åŠ¨èƒŒæ™¯
            loop(); // å¯åŠ¨ä¸»å¾ªç¯
            startCamera(); // å¯åŠ¨AI
            AudioEngine.playSuccess();
        }

        // çˆ†ç‚¸ç‰¹æ•ˆ
        function boom(x, y) {
            AudioEngine.playBoom();
            for(let i=0; i<80; i++) particles.push(new Particle(x, y, 'fire'));
        }

        // AI ç»“æœå¤„ç†
        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                document.getElementById('hand-status').innerText = "TRACKING LOCKED";
                document.getElementById('hand-status').style.color = "#0f0";
                
                const lm = results.multiHandLandmarks[0]; // åªå–ç¬¬ä¸€åªæ‰‹
                
                // åæ ‡è½¬æ¢ (é•œåƒ)
                const getCoord = (idx) => ({ 
                    x: (1 - lm[idx].x) * width, 
                    y: lm[idx].y * height 
                });

                handPos = getCoord(9); // æŒå¿ƒ (ä¸­æŒ‡æ ¹éƒ¨)
                indexPos = getCoord(8); // é£ŸæŒ‡å°–

                // ç»˜åˆ¶èµ›åšéª¨éª¼
                drawCyberHand(ctx, lm);

                // æ‰‹åŠ¿åˆ¤æ–­é€»è¾‘
                const isIndexUp = lm[8].y < lm[6].y;
                const isMiddleUp = lm[12].y < lm[10].y;
                const isRingUp = lm[16].y < lm[14].y;
                const isPinkyUp = lm[20].y < lm[18].y;

                // ğŸŸ¢ æ¨¡å¼ 1: å•æŒ‡ (ç»˜å›¾)
                if (isIndexUp && !isMiddleUp && !isRingUp && !isPinkyUp) {
                    document.getElementById('gesture-mode').innerText = "Magic Pen";
                    isFist = false;
                    // äº§ç”Ÿé­”æ³•ç²’å­
                    for(let i=0; i<4; i++) particles.push(new Particle(indexPos.x, indexPos.y, 'magic'));
                    if(Math.random()>0.8) AudioEngine.playSparkle();
                }
                
                // ğŸ”´ æ¨¡å¼ 2: æ¡æ‹³ (èšèƒ½)
                else if (!isIndexUp && !isMiddleUp && !isRingUp && !isPinkyUp) {
                    document.getElementById('gesture-mode').innerText = "Gravity Well";
                    isFist = true; // å¼€å¯å¼•åŠ›
                } 
                
                // ğŸ”µ æ¨¡å¼ 3: å‰ªåˆ€æ‰‹ (å¼€å¥–)
                else if (isIndexUp && isMiddleUp && !isRingUp && !isPinkyUp) {
                    document.getElementById('gesture-mode').innerText = "Victory";
                    // å¦‚æœä¹‹å‰åœ¨æ¡æ‹³ï¼Œç°åœ¨æ¾å¼€å˜æˆå‰ªåˆ€æ‰‹ -> è§¦å‘å¤§çˆ†ç‚¸
                    if (isFist) { 
                        boom(handPos.x, handPos.y);
                        isFist = false;
                    }
                    if (!showResult && !cooldown) openLuck();
                }

                // âšª æ¨¡å¼ 4: å¼ å¼€æ‰‹ (é‡ç½®)
                else if (isIndexUp && isMiddleUp && isRingUp && isPinkyUp) {
                    document.getElementById('gesture-mode').innerText = "Reset";
                    // å¦‚æœä¹‹å‰åœ¨æ¡æ‹³ï¼Œæ¾å¼€ -> çˆ†ç‚¸
                    if(isFist) { boom(handPos.x, handPos.y); isFist = false; }
                    
                    if (showResult) resetLuck();
                }
                else {
                    isFist = false;
                }

            } else {
                document.getElementById('hand-status').innerText = "SEARCHING...";
                document.getElementById('hand-status').style.color = "#f00";
                isFist = false;
            }
        }

        // ç»˜åˆ¶æ‰‹éƒ¨è¿çº¿ (Neon Style)
        function drawCyberHand(ctx, landmarks) {
            ctx.save();
            ctx.strokeStyle = 'rgba(0, 255, 255, 0.4)';
            ctx.lineWidth = 2;
            
            // ç®€å•çš„è¿æ¥é€»è¾‘
            const connections = [[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[5,9],[9,10],[10,11],[11,12],[9,13],[13,14],[14,15],[15,16],[13,17],[17,18],[18,19],[19,20],[0,17]];
            
            ctx.beginPath();
            for(let pair of connections) {
                const p1 = { x: (1 - landmarks[pair[0]].x) * width, y: landmarks[pair[0]].y * height };
                const p2 = { x: (1 - landmarks[pair[1]].x) * width, y: landmarks[pair[1]].y * height };
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
            }
            ctx.stroke();

            // å…³èŠ‚èŠ‚ç‚¹
            ctx.fillStyle = '#0ff';
            for(let lm of landmarks) {
                const x = (1 - lm.x) * width;
                const y = lm.y * height;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI*2);
                ctx.fill();
            }
            ctx.restore();
        }

        // å¼€å¥–é€»è¾‘
        const fortunes = [
            {w:"å¤©é€‰", t:"èµ›åšè´¢ç¥å·²ä¸Šçº¿ï¼Œä½ çš„è´¦æˆ·æ­£åœ¨åŒæ­¥å®‡å®™èƒ½é‡ã€‚"},
            {w:"è§‰é†’", t:"æ–°çš„ä¸€å¹´ï¼Œæ½œèƒ½çˆ†å‘ï¼Œä½ å°†æˆä¸ºé‚£ä¸ªä¸å¯æ›¿ä»£çš„ä¼ å¥‡ã€‚"},
            {w:"ç ´å£", t:"æ‰€æœ‰é˜»ç¢ä½ çš„äººå’Œäº‹ï¼Œéƒ½å°†æˆä¸ºä½ ç™»é¡¶çš„å«è„šçŸ³ã€‚"},
            {w:"æ¬§çš‡", t:"ç¨€æœ‰åº¦ï¼šSSRã€‚è¿æ°”å€¼å·²é”å®šæœ€é«˜ä¸Šé™ã€‚"},
            {w:"æ°¸æ’", t:"å¥åº·å€¼ MAXï¼Œé­…åŠ›å€¼ MAXï¼Œä½ çš„å…‰èŠ’æ— äººèƒ½æŒ¡ã€‚"}
        ];

        function openLuck() {
            cooldown = true;
            showResult = true;
            
            const lucky = fortunes[Math.floor(Math.random() * fortunes.length)];
            document.getElementById('card-word').innerText = lucky.w;
            document.getElementById('card-text').innerText = lucky.t;
            
            cardBox.style.display = 'block';
            AudioEngine.playSuccess();
            boom(width/2, height/2);

            setTimeout(() => cooldown = false, 2000);
        }

        function resetLuck() {
            cardBox.style.display = 'none';
            showResult = false;
            AudioEngine.playTone(600, 'triangle', 0.1, 0.05); // ç®€å•çš„é‡ç½®éŸ³
        }

        // åˆå§‹åŒ– MediaPipe
        function startCamera() {
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
            hands.onResults(onResults);

            const camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 640, height: 480
            });
            camera.start();
        }

    </script>
</body>
</html>
