<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 æŒ‡å°–é­”æ³•Â·æ–°æ˜¥ç¥ˆç¦</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    
    <!-- MediaPipe AI åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body {
            margin: 0;
            background: #000;
            overflow: hidden;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        /* æ ¸å¿ƒç”»å¸ƒ */
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            /* å…³é”®ï¼šç»™ç²’å­å¢åŠ å‘å…‰è´¨æ„Ÿ */
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.5)); 
        }

        /* UI å±‚ */
        #ui-layer {
            position: absolute;
            z-index: 10;
            width: 100%;
            height: 100%;
            pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€åˆ°ç”»å¸ƒ */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* æ‘„åƒå¤´å°çª— */
        .cam-preview {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 160px;
            height: 120px;
            border: 2px solid #FFD700;
            border-radius: 12px;
            overflow: hidden;
            opacity: 0.8;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
            box-shadow: 0 0 15px #FFD700;
        }
        
        .cam-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* æŠ½ç­¾å¡ç‰‡ */
        .lucky-card {
            background: rgba(20, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border: 2px solid #D90429;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            color: #fff;
            box-shadow: 0 0 50px rgba(217, 4, 41, 0.5);
            transform: scale(0);
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: auto;
        }
        
        .lucky-card.active {
            transform: scale(1);
        }

        .lucky-word {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 5rem;
            background: linear-gradient(to bottom, #FFD700, #ff8c00);
            -webkit-background-clip: text;
            color: transparent;
            margin: 10px 0;
            text-shadow: 0 5px 20px rgba(255, 69, 0, 0.5);
        }

        /* ç©æ³•æç¤º */
        .guide-box {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            color: white;
        }
        .gesture-row {
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            opacity: 0.8;
        }
        .key {
            background: #333;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #666;
            color: #FFD700;
            font-weight: bold;
        }

        /* åŠ è½½å±‚ */
        #loading {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #FFD700;
            flex-direction: column;
        }
    </style>
</head>
<body>

    <div id="loading">
        <h1>ğŸ”® æ­£åœ¨æ³¨å…¥é­”æ³•èƒ½é‡...</h1>
        <p>è¯·å…è®¸æ‘„åƒå¤´æƒé™ä»¥æ¿€æ´» AI å¼•æ“</p>
    </div>

    <canvas id="main-canvas"></canvas>

    <div id="ui-layer">
        <div class="status-hud">
            AI çŠ¶æ€: <span id="ai-status" style="color:yellow">åˆå§‹åŒ–ä¸­...</span> | å½“å‰æ‰‹åŠ¿: <span id="gesture-name" style="color:#00ffcc; font-weight:bold">-</span>
        </div>

        <div class="guide-box">
            <div class="gesture-row"><span>ğŸ‘† å•æŒ‡ç§»åŠ¨</span> <span class="key">ç»˜å›¾é­”æ³•</span></div>
            <div class="gesture-row"><span>âœŠ æ¡ç´§æ‹³å¤´</span> <span class="key">å¬å”¤è´¢è¿</span></div>
            <div class="gesture-row"><span>âœŒï¸ å‰ªåˆ€æ‰‹</span> <span class="key">æŠ½å–çµç­¾</span></div>
            <div class="gesture-row"><span>âœ‹ å¼ å¼€æ‰‹æŒ</span> <span class="key">é‡ç½®æ¸…å±</span></div>
        </div>

        <div class="lucky-card" id="card">
            <div style="font-size:1.2rem; color:#aaa">2025 ä¹™å·³è›‡å¹´ Â· è¿åŠ¿</div>
            <div class="lucky-word" id="card-word">å¤§å‰</div>
            <div id="card-text" style="font-size:1.1rem; line-height:1.6; max-width:300px;"></div>
        </div>
    </div>

    <div class="cam-preview">
        <video id="input_video" autoplay playsinline muted></video>
    </div>

    <script>
        /* -----------------------------------------------------------
           PART 1: ç²’å­ç‰©ç†å¼•æ“ (Physics Engine)
           ----------------------------------------------------------- */
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let particles = [];
        let goldCoins = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // é€šç”¨ç²’å­ç±» (ç”¨äºæŒ‡å°–é­”æ³•å’ŒçƒŸèŠ±)
        class Particle {
            constructor(x, y, type = 'magic') {
                this.x = x;
                this.y = y;
                this.type = type;
                
                // é­”æ³•ç²’å­ (æŒ‡å°–)
                if (type === 'magic') {
                    this.vx = (Math.random() - 0.5) * 2;
                    this.vy = (Math.random() - 0.5) * 2;
                    this.size = Math.random() * 4 + 1;
                    this.life = 60; // å­˜æ´»å¸§æ•°
                    this.color = `hsl(${Math.random()*60 + 180}, 100%, 70%)`; // è“é’è‰²ç³»
                    this.decay = 0.95;
                } 
                // çˆ†ç‚¸ç²’å­ (çƒŸèŠ±)
                else if (type === 'fire') {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 5 + 2;
                    this.vx = Math.cos(angle) * speed;
                    this.vy = Math.sin(angle) * speed;
                    this.size = Math.random() * 3 + 2;
                    this.life = 80;
                    this.color = `hsl(${Math.random()*40 + 340}, 100%, 60%)`; // çº¢ç´«è‰²ç³»
                    this.decay = 0.92;
                    this.gravity = 0.1;
                }
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life--;
                this.size *= 0.95;
                
                if (this.type === 'fire' && this.gravity) {
                    this.vy += this.gravity;
                }
            }

            draw() {
                ctx.globalCompositeOperation = 'lighter'; // å…³é”®ï¼šå åŠ å‘å…‰æ¨¡å¼
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalCompositeOperation = 'source-over';
            }
        }

        // é‡‘å¸ç±» (ç”¨äºæ¡æ‹³)
        class GoldCoin {
            constructor() {
                this.x = Math.random() * width;
                this.y = -50; // ä»å¤©è€Œé™
                this.size = Math.random() * 15 + 10;
                this.vy = Math.random() * 5 + 5; // ä¸‹è½é€Ÿåº¦
                this.rotation = Math.random() * Math.PI;
                this.rotSpeed = 0.1;
                this.text = ["ğŸ’°", "ğŸ§§", "ğŸ"][Math.floor(Math.random()*3)];
            }
            update() {
                this.y += this.vy;
                this.rotation += this.rotSpeed;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.font = `${this.size}px Arial`;
                ctx.fillText(this.text, -this.size/2, -this.size/2);
                ctx.restore();
            }
        }

        function createMagicTrail(x, y) {
            for(let i=0; i<5; i++) {
                particles.push(new Particle(x, y, 'magic'));
            }
        }

        function createExplosion(x, y) {
            for(let i=0; i<50; i++) {
                particles.push(new Particle(x, y, 'fire'));
            }
        }

        function spawnWealth() {
            if (goldCoins.length < 100) { // é™åˆ¶æ•°é‡é˜²æ­¢å¡é¡¿
                goldCoins.push(new GoldCoin());
            }
        }

        // ä¸»æ¸²æŸ“å¾ªç¯
        function render() {
            // æ‹–å°¾æ•ˆæœï¼šä¸å®Œå…¨æ¸…é™¤ç”»å¸ƒï¼Œè€Œæ˜¯è¦†ç›–ä¸€å±‚åŠé€æ˜é»‘è‰²
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, width, height);

            // æ›´æ–°ç»˜åˆ¶ç²’å­
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.update();
                p.draw();
                if (p.life <= 0) particles.splice(i, 1);
            }

            // æ›´æ–°ç»˜åˆ¶é‡‘å¸
            for (let i = goldCoins.length - 1; i >= 0; i--) {
                const g = goldCoins[i];
                g.update();
                g.draw();
                if (g.y > height) goldCoins.splice(i, 1);
            }

            requestAnimationFrame(render);
        }
        render();


        /* -----------------------------------------------------------
           PART 2: AI æ‰‹åŠ¿è¯†åˆ«é€»è¾‘ (Gesture Logic)
           ----------------------------------------------------------- */
        
        const videoElement = document.getElementById('input_video');
        const card = document.getElementById('card');
        const statusSpan = document.getElementById('ai-status');
        const gestureSpan = document.getElementById('gesture-name');

        // è¿åŠ¿æ•°æ®
        const fortunes = [
            {w:"æš´å¯Œ", t:"ä»Šå¹´ä½ çš„è´¢è¿åƒå¼€äº†æŒ‚ï¼Œå­˜æ¬¾ä½æ•°è¦å¢åŠ ï¼"},
            {w:"æ¡ƒèŠ±", t:"é­…åŠ›å€¼æ‹‰æ»¡ï¼Œé‚£ä¸ªTAæ­£åœ¨æƒ³åŠæ³•é‡è§ä½ ã€‚"},
            {w:"ä¸Šå²¸", t:"é€¢è€ƒå¿…è¿‡ï¼Œæ‰€æœ‰åŠªåŠ›ç»ˆå°†å…‘ç°æˆå½•å–é€šçŸ¥ä¹¦ã€‚"},
            {w:"èººèµ¢", t:"ä¸ç”¨å·ä¹Ÿèƒ½èµ¢ï¼Œå…¨è‡ªåŠ¨å¥½è¿ç³»ç»Ÿå·²éƒ¨ç½²ã€‚"},
            {w:"å¥åº·", t:"å‘é‡æƒŠäººï¼Œç¡çœ è¶…å¥½ï¼Œèº«ä½“å€å„¿æ£’ï¼"}
        ];

        let isCardShown = false;
        let cooldown = false;

        function onResults(results) {
            statusSpan.innerText = "è¿è¡Œä¸­ ğŸŸ¢";
            statusSpan.style.color = "#0f0";
            document.getElementById('loading').style.display = 'none';

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                // å°† AI åæ ‡ (0-1) è½¬æ¢ä¸º ç”»å¸ƒåæ ‡ (px)
                // æ³¨æ„ï¼šå› ä¸ºè§†é¢‘æ˜¯é•œåƒçš„ï¼Œæ‰€ä»¥ X åæ ‡è¦åšç¿»è½¬å¤„ç† (1 - x)
                const indexTip = { x: (1 - landmarks[8].x) * width, y: landmarks[8].y * height };
                const thumbTip = { x: (1 - landmarks[4].x) * width, y: landmarks[4].y * height };
                
                // === æ‰‹åŠ¿ç‰¹å¾è®¡ç®— ===
                
                // 1. æ‰‹æŒ‡æ˜¯å¦ä¼¸ç›´ (æŒ‡å°– y < æŒ‡å…³èŠ‚ y)
                const isIndexUp = landmarks[8].y < landmarks[6].y;
                const isMiddleUp = landmarks[12].y < landmarks[10].y;
                const isRingUp = landmarks[16].y < landmarks[14].y;
                const isPinkyUp = landmarks[20].y < landmarks[18].y;
                const isThumbOpen = landmarks[4].x < landmarks[3].x; // ç®€åŒ–åˆ¤æ–­

                let currentGesture = "æœªçŸ¥";

                // --- é€»è¾‘åˆ¤æ–­ ---

                // ğŸŒŸ åœºæ™¯ 1: å•æŒ‡ç»˜å›¾ (Magic Finger)
                // é£ŸæŒ‡ä¼¸ç›´ï¼Œå…¶ä»–å¼¯æ›²
                if (isIndexUp && !isMiddleUp && !isRingUp && !isPinkyUp) {
                    currentGesture = "ğŸ‘† ç»˜å›¾æ¨¡å¼";
                    createMagicTrail(indexTip.x, indexTip.y);
                }

                // ğŸ’° åœºæ™¯ 2: æ¡æ‹³ (Fist)
                // æ‰€æœ‰æ‰‹æŒ‡éƒ½å¼¯æ›²
                else if (!isIndexUp && !isMiddleUp && !isRingUp && !isPinkyUp) {
                    currentGesture = "âœŠ å¬å”¤è´¢è¿";
                    spawnWealth(); // ä¸‹é‡‘å¸
                    spawnWealth();
                }

                // ğŸ§§ åœºæ™¯ 3: å‰ªåˆ€æ‰‹ (Victory) -> å¼€å¥–
                else if (isIndexUp && isMiddleUp && !isRingUp && !isPinkyUp) {
                    currentGesture = "âœŒï¸ æŠ½å–çµç­¾";
                    if (!isCardShown && !cooldown) {
                        triggerLottery(indexTip.x, indexTip.y); // åœ¨æŒ‡å°–å¤„çˆ†ç‚¸
                    }
                }

                // ğŸ”„ åœºæ™¯ 4: å¼ å¼€æ‰‹æŒ (Open Palm) -> é‡ç½®
                else if (isIndexUp && isMiddleUp && isRingUp && isPinkyUp) {
                    currentGesture = "âœ‹ é‡ç½®ç³»ç»Ÿ";
                    if (isCardShown) {
                        resetSystem();
                    }
                }

                gestureSpan.innerText = currentGesture;
            } else {
                gestureSpan.innerText = "æœªæ£€æµ‹åˆ°æ‰‹éƒ¨";
            }
        }

        // è§¦å‘å¼€å¥–
        function triggerLottery(x, y) {
            cooldown = true;
            createExplosion(x, y); // è§†è§‰åé¦ˆ
            createExplosion(width/2, height/2);

            const lucky = fortunes[Math.floor(Math.random() * fortunes.length)];
            document.getElementById('card-word').innerText = lucky.w;
            document.getElementById('card-text').innerText = lucky.t;
            
            card.classList.add('active');
            isCardShown = true;

            setTimeout(() => cooldown = false, 2000);
        }

        // é‡ç½®
        function resetSystem() {
            card.classList.remove('active');
            isCardShown = false;
            goldCoins = []; // æ¸…ç©ºé‡‘å¸
        }

        // åˆå§‹åŒ– MediaPipe
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });

        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });

        camera.start().catch(e => {
            document.getElementById('loading').innerHTML = `<h2 style="color:red">æ‘„åƒå¤´å¯åŠ¨å¤±è´¥</h2><p>${e}</p>`;
        });

    </script>
</body>
</html>
